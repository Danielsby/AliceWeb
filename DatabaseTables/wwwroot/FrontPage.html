<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Alice FrontPage</title>

    <link rel="stylesheet" type="text/css" href="./css/CSSFile.css">
    <script type="text/javascript" src="./js/JSFile.js"></script>


    <!--Icons-->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="js/error.js"></script>

</head>

<body>

    <div class="grid-container">
        <div class="item1">
            <!--Dette er horisontal meny, ikke vertical. Jeg har skrevet feil, rydder i dette senere-->
            <div class="verticalmenu">
                <nav>
                    <ul>
                        <li style="float:left"><a href="./FSMControl.html">FSM Control Panel</a></li>
                        <li style="float:left"><a href="./FSMControl.html">FSM Management Panel</a></li>
                        <li style="float:left"><a href="./FSMControl.html">Alarm Panel</a></li>


                        <li style="float:right">
                            <div class="dropdown">

                                <button onclick="myFunction()" class="dropbtn"><i class='fas fa-user'></i> User <i class='fas fa-angle-down'></i></button>
                                <div id="User" class="dropdown-content">
                                    <a href="./default.html">Logout</a>
                                    <a href="./default.html">Some</a>
                                    <a href="./default.html">Thing</a>
                                </div>
                            </div>
                        </li>

                        <li style="float: right">
                            <div class="dropdown">
                                <button onclick="myFunction2()" class="dropbtn"><i class='fas fa-cog'></i> Settings <i class='fas fa-angle-down'></i></button>
                                <div id="Settings" class="dropdown-content">
                                    <a href="./default.html">Set</a>
                                    <a href="./default.html">tin</a>
                                    <a href="./default.html">gs</a>
                                </div>
                            </div>
                        </li>

                        <!-- <li style="float:right"><a href="./default.html">Settings</a></li>  -->
                    </ul>
                </nav>
            </div>
        </div>

        <div class="item2">
            <div class="Logo">
                <a href="default.html">
                    <img src="./images/AliceLogo.png" alt="Alice Logo" height=200px width=auto>
                </a>
            </div>

            <div class="menu">
                <ul>
                    <li>SPD Sector 0</li>
                    <li>SPD Sector 1</li>
                    <li>SPD Sector 2</li>
                    <li>SPD Sector 3</li>
                    <li>SPD Sector 4</li>
                    <li>SPD Sector 5</li>
                    <li>SPD Sector 6</li>
                    <li>SPD Sector 7</li>
                    <li>SPD Sector 8</li>
                    <li>SPD Sector 9</li>
                </ul>
            </div>
        </div>

        <div class="item3">
            <!--
        Display relevant data to the user.
        Default: from the alice-detector.
    -->
            <canvas id="myChart"></canvas>

            <!-- Display the sectors. -->
            <button type="button" id="default">Pixel Detector</button>

            <!-- Display the temperatures. -->
            <button type="button" id="temp">Temperature</button>

            <!-- Send a GET request and show on graph from Log. -->
            <button type="button" id="errors">Errors</button>

            <!-- Send a PUT request to the wrong data and change to an acceptable number. -->
            <button type="button" id="issue">Solve</button>

            <!-- Send a PUT request to the wrong data and change to an acceptable number. -->
            <button type="button" id="reset">Reset</button>

            <!-- For information. -->
            <footer>
                <p>Copyright (c) 2019 Bachelor thesis </p>
            </footer>
        </div>

        <!-- Show something in these(?).  -->
        <div class="item4"></div>
        <div class="item5"></div>
    </div>


    <script>
        // TODO: Get data from request. 
        // TODO: Update chart.
        // TODO: Show both Amper and Temperature.


        /** Variables. */
        var aliceData = [20, 25, 23, 29, 17]; 

        var sectorUrl = "http://localhost:5000/api/sector";
        var logUrl = "http://localhost:5000/api/log";
        var tempUrl = "http://localhost:5000/api/temperature";

        /*
        var jsonString = test(url);
        const obj = JSON.parse(jsonString);
        console.log(Object.values(obj));

        const object1 = {
          a: 'somestring',
          b: 42,
          c: false
        };
        */


        /** Tests */

        // console.log(Object.values(object1));
        // alert(obj.oneHour);


        /** Functions. */

        /* On button click. */
        // document.getElementById("default").onclick = test(url);
        currentData = document.getElementById("errors").onclick = doFunction;
        currentData = document.getElementById("issue").onclick = doFunction;

        function doFunction() {
            window.alert("The test works.")
        }

        function displayTemp() {

        }


        /* 
         * Change too low values into big enough values. 
        function fixError() {

        }
        */

        var ctx = document.getElementById('myChart').getContext('2d');
        /** Create the chart to show relevant data. */
        var chart = new Chart(ctx, {

            // The type of chart we want to create
            type: 'bar',

            // The data for our dataset
            data: {
                labels: ["0 hour ago", "1 hours ago", "2 hours ago", "3 hours ago", "4 hours ago"],
                datasets: [{
                    label: "Measurements",
                    backgroundColor: 'rgb(255, 99, 132)',
                    borderColor: 'rgb(255, 99, 132)',
                    data: aliceData
                }]
            },

            // Configuration options go here
            options: {}
        }); // End of create a chart.

        /* Show the sectors. */
        document.getElementById("default").onclick = function test() {

            // Change type of chart. 
            // Show only green og red. 
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", sectorUrl, false);
            xmlHttp.send(null);
            var obj = xmlHttp.responseText;
            console.log(obj);
            var jsonResponse = JSON.parse(obj);

            console.log(jsonResponse);
            
            // Update the values. 
            aliceData = Object.values(jsonResponse["0"]);
            aliceData.shift();

            // Update the chart.
            // chart.type = 'line';
            // chart.data.datasets.type = 'radar';
            chart.data.datasets[0].type = 'bubble';
            chart.data.labels = ["Sector 1", "Sector 2", "Sector 3", "Sector 4",
                "Sector 5","Sector 6", "Sector 7", "Sector 8", "Sector 9"];
            chart.data.datasets[0].data = aliceData;
            chart.data.datasets[0].label = "Sectors";
            chart.update();

            for (i = 0; i < aliceData.length; i++) {
                if (aliceData[i] == 0) {
                    window.confirm("One of the detectors are down. Click Solve button.");
                }
            }
        }
        

        /* Show the temperature. */
        document.getElementById("temp").onclick = function test() {

            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", tempUrl, false);
            xmlHttp.send(null);

            var obj = xmlHttp.responseText;
            console.log(obj);
            var jsonResponse = JSON.parse(obj);

            // Update the values. 
            aliceData = Object.values(jsonResponse["0"]);
            aliceData.shift();
            
            // Red when it go under the allowed temperature. 
            // Update the chart.
            chart.data.datasets[0].type = 'bar';
            chart.data.labels = ["0 hour ago", "1 hours ago", "2 hours ago", "3 hours ago"];
            chart.data.datasets[0].data = aliceData;
            chart.data.datasets[0].label = "Temperature";

            chart.update();

            for (i = 0; i < aliceData.length; i++) {
                if (aliceData[i] < 20) {
                    window.confirm("One or several temperatures are under 20 Celcius. Click Solve button.");
                }
            }
        }

        /* Show the errors. */
        document.getElementById("errors").onclick = function test() {

            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", logUrl, false);
            xmlHttp.send(null);
            
            var obj = xmlHttp.responseText;
            console.log(obj);
            var jsonResponse = JSON.parse(obj);
            
            // Update the values. 
            aliceData = Object.values(jsonResponse["0"]);
            aliceData.shift();

            // Update the chart.
            chart.data.datasets[0].data = aliceData;
            chart.data.datasets[0].type = 'bar';
            chart.data.labels = ["Antall errors"];
            chart.data.datasets[0].label = "Errors";

            chart.update();
        }

        /* Fix the errors. */
        document.getElementById("issue").onclick = function test() {

            // Sector 4 is broken. Fix. 

            // Change type of chart. 
            // Show only green og red. 
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", sectorUrl, false);
            xmlHttp.send(null);
            var obj = xmlHttp.responseText;
            console.log(obj);
            var jsonResponse = JSON.parse(obj);

            console.log(jsonResponse);
            
            // Update the values. 
            var check = Object.values(jsonResponse["0"]);

            var i;
            var sectorToChange;
            for (i = 0; i < check.length; i++) {
                if (check[i] == 0) {
                    sectorToChange = i;
                    console.log(i);
                }       
            }

            // Update a user.
            var url = "http://localhost:5000/api/sector/";
            var changeUrl = url + sectorToChange;

            console.log("The url is: " + changeUrl);

            var data = {};
            data.id = sectorToChange;
            var json = JSON.stringify(data);

            var xhr = new XMLHttpRequest();
            xhr.open("PUT", changeUrl, true);
            xhr.setRequestHeader('Content-type','application/json; charset=utf-8');
            xhr.onload = function () {
                if (xhr.readyState == 4 && xhr.status == "200") {

                }
            }

            xhr.send(json);

            // Register the click. 
            var clickUrl = "http://localhost:5000/api/log/1";

            var data = {};
            data.id = sectorToChange;
            var json = JSON.stringify(data);

            var xhr = new XMLHttpRequest();
            xhr.open("PUT", clickUrl, true);
            xhr.setRequestHeader('Content-type','application/json; charset=utf-8');
            xhr.onload = function () {
                if (xhr.readyState == 4 && xhr.status == "200") {

                }
            }

            xhr.send(json);

            chart.update();
        }

        /* Reset errors. */
        document.getElementById("reset").onclick = function test() {

            // Register the click. 
            var clickUrl = "http://localhost:5000/api/reset/0";

            var data = {};
            data.id = sectorToChange;
            var json = JSON.stringify(data);

            var xhr = new XMLHttpRequest();
            xhr.open("PUT", clickUrl, true);
            xhr.setRequestHeader('Content-type','application/json; charset=utf-8');
            xhr.onload = function () {
                if (xhr.readyState == 4 && xhr.status == "200") {

                }
            }

            xhr.send(json);

            chart.update();
        }

        /* Load function to check the status of the page. */
        /*
        window.onload = function test() {
            for (i = 0; i < aliceData.length; i++) {
                if (aliceData[i] < 15) {
                    window.confirm("One of the values are too low. Click the button.");
                }
            }
        }
        */
    </script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>
